{% extends "base.html" %}

{% block title %}Dashboard - {{ super() }}{% endblock %}

{% block extra_css %}
<style>
.stay-timeline {
    transition: transform 0.2s, box-shadow 0.2s;
}

.stay-timeline:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.timeline-container {
    position: relative;
    margin-top: 10px;
}

.session-bar {
    transition: transform 0.2s, box-shadow 0.2s;
}

.session-bar:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    z-index: 10;
}

.stay-bar {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Pulsing effect for active sessions */
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

.session-bar[style*="linear-gradient"] {
    animation: pulse 2s ease-in-out infinite;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-speedometer2"></i> Dashboard
        </h1>
    </div>
</div>

<!-- Service Status (Admin/Operator only) -->
{% if current_user.permission_level <= 500 %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-gear"></i> Service Status</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for service in services %}
                    <div class="col-md-4">
                        <div class="d-flex align-items-center mb-2">
                            <span class="service-status {{ service.status }}"></span>
                            <strong>{{ service.name }}</strong>
                            <span class="ms-2 badge bg-secondary">Port {{ service.port }}</span>
                        </div>
                        {% if service.uptime %}
                        <small class="text-muted">Uptime: {{ service.uptime }}</small>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Statistics Cards (Admin only) -->
{% if current_user.permission_level <= 500 %}
<div class="row mb-4" id="dashboardStats">
    <div class="col-md-2 mb-3">
        <div class="card stats-card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="stat-value text-white">{{ stats.total_users }}</p>
                        <p class="stat-label mb-0 text-white">Total Persons</p>
                    </div>
                    <i class="bi bi-people stat-icon"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-2 mb-3">
        <div class="card stats-card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="stat-value text-white">{{ stats.total_servers }}</p>
                        <p class="stat-label mb-0 text-white">Total Servers</p>
                    </div>
                    <i class="bi bi-hdd-network stat-icon"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-2 mb-3">
        <div class="card stats-card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="stat-value text-white">{{ stats.active_grants }}</p>
                        <p class="stat-label mb-0 text-white">Active Grants</p>
                    </div>
                    <i class="bi bi-key stat-icon"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stats-card bg-success text-white border border-success border-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="stat-value text-white">{{ stats.people_inside }}</p>
                        <p class="stat-label mb-0 text-white"><i class="bi bi-door-open"></i> Persons Inside</p>
                    </div>
                    <i class="bi bi-person-badge stat-icon"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stats-card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="stat-value text-dark">{{ stats.today_connections }}</p>
                        <p class="stat-label mb-0 text-dark">Today's Connections</p>
                    </div>
                    <i class="bi bi-arrow-right-circle stat-icon"></i>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Active Sessions Chart (Admin only) -->
{% if current_user.permission_level <= 500 %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Active Sessions by Stay</h5>
            </div>
            <div class="card-body">
                <canvas id="sessionsChart" style="max-height: 300px;"></canvas>
                <div id="chartLegend" class="mt-3"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Real-time Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h3 class="text-primary mb-0" id="liveActiveStays">0</h3>
                        <small class="text-muted">Active Stays</small>
                    </div>
                    <div class="col-6 mb-3">
                        <h3 class="text-success mb-0" id="liveActiveSessions">0</h3>
                        <small class="text-muted">Active Sessions</small>
                    </div>
                    <div class="col-12">
                        <small class="text-muted">
                            <i class="bi bi-arrow-clockwise"></i> Updates every 5 seconds
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Active Stays Timeline - Unified Daily View -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-day"></i> {% if current_user.permission_level >= 900 %}Your today's timeline{% else %}Today's Timeline: Who Was/Is Inside{% endif %}
                    <span class="badge bg-light text-dark ms-2" id="staysCount">{{ active_stays|length }} active</span>
                </h5>
            </div>
            <div class="card-body" id="staysTimeline">
                
                <!-- Stays Timeline - Each stay has its own timeline -->
                <div class="unified-timeline-container mb-3">
                    
                    <!-- Stays rows - each with own timeline -->
                    {% if active_stays %}
                    <div class="stays-rows position-relative">
                        {% for stay in active_stays %}
                        {# Each stay has its own timeline: from start to end/now #}
                        {% set stay_end_time = stay.ended_at if not stay.is_active else now %}
                        {% set stay_duration = (stay_end_time - stay.started_at).total_seconds()|int %}
                        
                        <!-- Stay row -->
                        <div class="stay-row mb-3 p-2 border border-{{ 'success' if stay.is_active else 'secondary' }} rounded" style="background: #f8f9fa;">
                            <!-- Person label -->
                            <div class="d-flex align-items-center mb-2">
                                <div style="width: 100%;">
                                    <span class="badge bg-{{ 'success' if stay.is_active else 'secondary' }} me-2">
                                        {{ 'INSIDE' if stay.is_active else 'Left' }}
                                    </span>
                                    <strong>{{ stay.user.full_name or stay.user.username }}</strong>
                                    <small class="text-muted ms-2">
                                        Stay #{{ stay.id }} | 
                                        {{ stay.started_at|localtime|truncate(5, True, '') }} - 
                                        {% if stay.is_active %}Now{% else %}{{ stay.ended_at|localtime|truncate(5, True, '') }}{% endif %}
                                        ({% set hours = stay_duration // 3600 %}{% set minutes = (stay_duration % 3600) // 60 %}{{ hours }}h {{ minutes }}m)
                                        | {{ stay.sessions|length }} session(s)
                                    </small>
                                    <a href="{{ url_for('stays.detail', stay_id=stay.id) }}" class="btn btn-sm btn-outline-{{ 'success' if stay.is_active else 'secondary' }} float-end">
                                        <i class="bi bi-eye"></i> Details
                                    </a>
                                </div>
                            </div>
                            
                            {# Stay's own timeline axis #}
                            <div class="d-flex align-items-center mb-2" style="font-size: 0.75rem;">
                                <span class="text-muted">{{ stay.started_at|time_short }}</span>
                                <div class="timeline-arrow position-relative mx-2 flex-grow-1" style="height: 2px; background: {% if stay.is_active %}#28a745{% else %}#6c757d{% endif %};">
                                    <div class="position-absolute" style="right: -8px; top: -3px; width: 0; height: 0; border-left: 8px solid {% if stay.is_active %}#28a745{% else %}#6c757d{% endif %}; border-top: 4px solid transparent; border-bottom: 4px solid transparent;"></div>
                                </div>
                                <span class="text-muted"><strong>{% if stay.is_active %}Now ({{ now|time_short }}){% else %}{{ stay.ended_at|time_short }}{% endif %}</strong></span>
                            </div>
                            
                            <!-- Stay timeline with sessions grouped by backend -->
                            {# First group sessions and calculate tracks #}
                            {% set sessions_by_backend = {} %}
                            {% for session in stay.sessions %}
                                {% set backend_key = session.server.name if session.server else session.backend_ip %}
                                {% if backend_key not in sessions_by_backend %}
                                    {% set _ = sessions_by_backend.update({backend_key: []}) %}
                                {% endif %}
                                {% set _ = sessions_by_backend[backend_key].append(session) %}
                            {% endfor %}
                            
                            {% set ns = namespace(total_tracks=0) %}
                            {% for backend_name, backend_sessions in sessions_by_backend.items() %}
                                {# Sort sessions by start time #}
                                {% set sorted_sessions = backend_sessions|sort(attribute='started_at') %}
                                
                                {# Pack sessions into non-overlapping tracks #}
                                {% set tracks = [] %}
                                {% for session in sorted_sessions %}
                                    {% set placed = False %}
                                    {% for track in tracks %}
                                        {% if not placed %}
                                            {% set last_session = track[-1] %}
                                            {% if last_session.ended_at and session.started_at >= last_session.ended_at %}
                                                {% set _ = track.append(session) %}
                                                {% set placed = True %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if not placed %}
                                        {% set _ = tracks.append([session]) %}
                                    {% endif %}
                                {% endfor %}
                                {% set _ = sessions_by_backend.update({backend_name: tracks}) %}
                                {% set ns.total_tracks = ns.total_tracks + tracks|length %}
                            {% endfor %}
                            
                            {% set sessions_height = (ns.total_tracks * 40) + 10 %}
                            <div class="sessions-in-stay position-relative" style="height: {{ sessions_height }}px; min-height: 45px;">
                                <!-- Stay background bar (full width of its own timeline) -->
                                <div class="stay-bg-bar position-absolute" 
                                     style="left: 0%; 
                                            width: 100%; 
                                            height: 100%;
                                            background: {% if stay.is_active %}rgba(40, 167, 69, 0.1){% else %}rgba(108, 117, 125, 0.1){% endif %};
                                            border: 2px solid {% if stay.is_active %}#28a745{% else %}#6c757d{% endif %};
                                            border-radius: 4px;">
                                </div>
                                
                                <!-- Render sessions grouped by backend in tracks -->
                                <div class="backend-groups">
                                {% for backend_name, tracks in sessions_by_backend.items() %}
                                    {# Each track is a row of non-overlapping sessions #}
                                    {% for track in tracks %}
                                    <div class="backend-row position-relative" style="height: 35px; margin-bottom: 5px;">
                                        {% for session in track %}
                                    {% set session_start_offset = (session.started_at - stay.started_at).total_seconds() %}
                                    {# For active sessions, use stay end time (now or ended_at) #}
                                    {% set session_end = session.ended_at if session.ended_at else stay_end_time %}
                                    {% set session_duration = (session_end - session.started_at).total_seconds() %}
                                    {% set session_left_percent = (session_start_offset / stay_duration * 100)|round(2) if stay_duration > 0 else 0 %}
                                    {% set session_width_percent = (session_duration / stay_duration * 100)|round(2) if stay_duration > 0 else 0 %}
                                
                                {# Build interactive popover content #}
                                {% set popover_content %}
                                <table class="table table-sm table-borderless mb-0" style="font-size: 0.75rem;">
                                    <tr><td><strong>Person:</strong></td><td><a href="{{ url_for('users.view', user_id=stay.user.id) }}" class="text-white">{{ stay.user.full_name or stay.user.username }}</a></td></tr>
                                    <tr><td><strong>Protocol:</strong></td><td>{{ session.protocol.upper() }}</td></tr>
                                    {% if session.ssh_username %}<tr><td><strong>SSH User:</strong></td><td>{{ session.ssh_username }}</td></tr>{% endif %}
                                    {% if session.server %}<tr><td><strong>Server:</strong></td><td><a href="{{ url_for('servers.view', server_id=session.server.id) }}" class="text-white">{{ session.server.name }}</a></td></tr>{% endif %}
                                    <tr><td><strong>Backend IP:</strong></td><td>{{ session.backend_ip }}</td></tr>
                                    <tr><td><strong>Source IP:</strong></td><td>{{ session.source_ip }}</td></tr>
                                    {% if session.subsystem_name %}<tr><td><strong>Subsystem:</strong></td><td>{{ session.subsystem_name }}</td></tr>{% endif %}
                                    {% if session.port_forwards_count and session.port_forwards_count > 0 %}<tr><td><strong>Port Forwards:</strong></td><td>{{ session.port_forwards_count }}</td></tr>{% endif %}
                                    <tr><td><strong>Started:</strong></td><td>{{ session.started_at|localtime }}</td></tr>
                                    {% if session.ended_at %}
                                        <tr><td><strong>Ended:</strong></td><td>{{ session.ended_at|localtime }}</td></tr>
                                        {% set duration_seconds = (session.ended_at - session.started_at).total_seconds()|int %}
                                        {% set duration_minutes = duration_seconds // 60 %}
                                        {% set duration_secs = duration_seconds % 60 %}
                                        <tr><td><strong>Duration:</strong></td><td>{{ duration_minutes }}m {{ duration_secs }}s</td></tr>
                                    {% else %}
                                        <tr><td><strong>Status:</strong></td><td><span class="badge bg-success">ACTIVE</span></td></tr>
                                    {% endif %}
                                </table>
                                <div class="text-center mt-2" style="font-size: 0.7rem; color: #999;">Click session bar to view details</div>
                                {% endset %}
                                
                                <div class="session-bar position-absolute d-flex align-items-center justify-content-between" 
                                     style="left: {{ session_left_percent }}%; 
                                            width: max({{ session_width_percent }}%, 50px);
                                            max-width: calc(100% - {{ session_left_percent }}%);
                                            min-width: 50px;
                                            height: 30px; 
                                            background: {% if session.is_active %}linear-gradient(90deg, #007bff 0%, #0056b3 100%){% else %}#6c757d{% endif %}; 
                                            border: 2px solid {% if session.is_active %}#0056b3{% else %}#495057{% endif %}; 
                                            border-radius: 4px;
                                            top: 0px;
                                            cursor: pointer;
                                            z-index: 10;
                                            overflow: hidden;"
                                     data-bs-toggle="popover" 
                                     data-bs-trigger="hover focus"
                                     data-bs-html="true"
                                     data-bs-container="body"
                                     data-bs-placement="top"
                                     data-bs-content="{{ popover_content|escape }}">
                                    <div class="px-2 text-white" style="font-size: 0.65rem;">
                                        {{ session.started_at|time_only }}
                                    </div>
                                    <div class="px-2 text-white text-center flex-grow-1" style="font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        <i class="bi bi-{% if session.protocol == 'ssh' %}terminal{% else %}display{% endif %}"></i>
                                        {% if session.ssh_username %}{{ session.ssh_username }}@{% endif %}{{ session.server.name if session.server else session.backend_ip|truncate(12) }}
                                    </div>
                                    <div class="px-2 text-white text-end" style="font-size: 0.65rem; min-width: 35px;">
                                        {% if session.ended_at %}
                                            {{ session.ended_at|time_only }}
                                        {% else %}
                                            <span class="badge bg-success" style="font-size: 0.55rem; padding: 1px 3px;">●</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                                </div>
                                {% endfor %}                                {% endfor %}                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0 ms-3">No stays today</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity section REMOVED - replaced with stays timeline above -->
<!-- Servers with IP Pool Allocations section REMOVED -->

<!--
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-hdd-network"></i> Servers & IP Pool Allocations</h5>
                <a href="{{ url_for('servers.index') }}" class="btn btn-sm btn-outline-primary">Manage Servers</a>
            </div>
            <div class="card-body">
                {% if server_allocations %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Server Name</th>
                                <th>Backend IP</th>
                                <th>SSH Port</th>
                                <th>RDP Port</th>
                                <th>IP Pool Allocation</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in server_allocations %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('servers.view', server_id=item.server.id) }}">
                                        <strong>{{ item.server.name }}</strong>
                                    </a>
                                </td>
                                <td><code>{{ item.server.ip_address }}</code></td>
                                <td><span class="badge bg-secondary">{{ item.server.ssh_port or 22 }}</span></td>
                                <td><span class="badge bg-secondary">{{ item.server.rdp_port or 3389 }}</span></td>
                                <td>
                                    {% if item.allocation %}
                                        <span class="badge bg-success" style="cursor: pointer;" 
                                              onclick="copyToClipboard('{{ item.allocation.allocated_ip }}', this)"
                                              title="Click to copy">
                                            <i class="bi bi-check-circle"></i> {{ item.allocation.allocated_ip }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">Not allocated</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.server.is_active %}
                                        <span class="badge badge-active">Active</span>
                                    {% else %}
                                        <span class="badge badge-inactive">Inactive</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No servers configured</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity section REMOVED - using Recent Sessions instead -->

{% endblock %}

{% block extra_js %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
let sessionsChart = null;

function copyToClipboard(text, element) {
    // Try modern clipboard API first
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
            showCopiedFeedback(element);
        }).catch(function(err) {
            // Fallback to older method
            fallbackCopy(text, element);
        });
    } else {
        // Fallback for older browsers
        fallbackCopy(text, element);
    }
}

function fallbackCopy(text, element) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    document.body.appendChild(textArea);
    textArea.select();
    
    try {
        document.execCommand('copy');
        showCopiedFeedback(element);
    } catch (err) {
        console.error('Failed to copy:', err);
        alert('Failed to copy: ' + text);
    }
    
    document.body.removeChild(textArea);
}

function showCopiedFeedback(element) {
    const originalHTML = element.innerHTML;
    element.innerHTML = '<i class="bi bi-clipboard-check"></i> Copied!';
    element.classList.remove('bg-success');
    element.classList.add('bg-info');
    
    setTimeout(function() {
        element.innerHTML = originalHTML;
        element.classList.remove('bg-info');
        element.classList.add('bg-success');
    }, 1500);
}

// Auto-refresh dashboard stats and stays timeline
function refreshDashboard() {
    // Refresh statistics
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            // Update all stats cards
            const totalUsersEl = document.querySelector('.stat-value:has(+ .stat-label:contains("Total Persons"))');
            if (totalUsersEl) totalUsersEl.textContent = data.total_users || '0';
            
            const totalServersEl = document.querySelector('.card.bg-success .stat-value');
            if (totalServersEl) totalServersEl.textContent = data.total_servers || '0';
            
            const activeGrantsEl = document.querySelector('.card.bg-info .stat-value');
            if (activeGrantsEl) activeGrantsEl.textContent = data.active_grants || '0';
            
            const peopleInsideEl = document.querySelectorAll('.card.bg-success .stat-value')[1];
            if (peopleInsideEl) peopleInsideEl.textContent = data.people_inside || '0';
            
            const todayConnectionsEl = document.querySelector('#todayConnections');
            if (todayConnectionsEl) todayConnectionsEl.textContent = data.today_connections || '0';
            
            const deniedEl = document.querySelector('#todayDenied');
            if (deniedEl) deniedEl.textContent = data.today_denied || '0';
            
            const successRateEl = document.querySelector('#successRate');
            if (successRateEl) successRateEl.textContent = (data.success_rate || '0') + '%';
        })
        .catch(err => console.error('Failed to refresh stats:', err));
    
    // Refresh stays timeline
    fetch('/api/stays')
        .then(response => response.json())
        .then(data => {
            refreshStaysTimeline(data);
            const activeStays = data.stays.filter(s => s.is_active);
            document.getElementById('staysCount').textContent = activeStays.length + ' active';
            
            // Update live stats
            const liveActiveStaysEl = document.getElementById('liveActiveStays');
            if (liveActiveStaysEl) liveActiveStaysEl.textContent = activeStays.length;
            
            // Count total active sessions
            const activeSessions = activeStays.reduce((sum, stay) => {
                return sum + stay.sessions.filter(s => s.is_active).length;
            }, 0);
            const liveActiveSessionsEl = document.getElementById('liveActiveSessions');
            if (liveActiveSessionsEl) liveActiveSessionsEl.textContent = activeSessions;
        })
        .catch(err => console.error('Failed to refresh stays:', err));
    
    // Refresh chart
    refreshChart();
}

// Refresh sessions chart
function refreshChart() {
    fetch('/api/stays-chart')
        .then(response => response.json())
        .then(data => {
            updateChart(data.stays);
        })
        .catch(err => console.error('Failed to refresh chart:', err));
}

// Update or create chart
function updateChart(stays) {
    const canvas = document.getElementById('sessionsChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    // Prepare data
    const labels = stays.map(s => s.user_name);
    const sessionCounts = stays.map(s => s.sessions_count);
    const colors = [
        '#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545',
        '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'
    ];
    
    // If chart exists, update data without animation
    if (sessionsChart) {
        sessionsChart.data.labels = labels;
        sessionsChart.data.datasets[0].data = sessionCounts;
        sessionsChart.data.datasets[0].backgroundColor = colors.slice(0, stays.length);
        sessionsChart.update('none');  // Update without animation
    } else {
        // Create new chart with animation (first time only)
        sessionsChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Active Sessions',
                    data: sessionCounts,
                    backgroundColor: colors.slice(0, stays.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                animation: {
                    duration: 750  // Animation only on first render
                },
                plugins: {
                    legend: {
                        display: false  // We'll use custom legend
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const stay = stays[context.dataIndex];
                                return `${context.label}: ${context.parsed} active session(s) (${stay.total_sessions} total)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Update custom legend
    const legendEl = document.getElementById('chartLegend');
    if (legendEl) {
        let legendHTML = '<div class="row">';
        stays.forEach((stay, index) => {
            const color = colors[index % colors.length];
            legendHTML += `
                <div class="col-6 mb-2">
                    <span style="display: inline-block; width: 12px; height: 12px; background: ${color}; border-radius: 50%; margin-right: 5px;"></span>
                    <small><strong>${stay.user_name}</strong>: ${stay.sessions_count} active (${stay.total_sessions} total)</small>
                </div>
            `;
        });
        legendHTML += '</div>';
        legendEl.innerHTML = legendHTML;
        
        if (stays.length === 0) {
            legendEl.innerHTML = '<p class="text-muted text-center mb-0">No active sessions</p>';
        }
    }
}

// Simple timeAgo function
function timeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    if (seconds < 60) return seconds + 's ago';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    return Math.floor(seconds / 86400) + 'd ago';
}

function refreshStaysTimeline(data) {
    const container = document.getElementById('staysTimeline');
    if (!container) return;
    
    // Parse 'now' as UTC (backend sends UTC without 'Z' suffix)
    const nowStr = data.now.endsWith('Z') ? data.now : data.now + 'Z';
    const now = new Date(nowStr);
    
    let html = '';
    
    // Container
    html += `<div class="unified-timeline-container mb-3">`;
    
    if (data.stays.length === 0) {
        html += '<p class="text-muted mb-0 ms-3">No stays today</p>';
    } else {
        html += '<div class="stays-rows position-relative">';
        
        data.stays.forEach(stay => {
            // Parse dates as UTC (add 'Z' if missing)
            const stayStartedStr = stay.started_at.endsWith('Z') ? stay.started_at : stay.started_at + 'Z';
            const stayStarted = new Date(stayStartedStr);
            const stayEnded = stay.ended_at ? new Date(stay.ended_at.endsWith('Z') ? stay.ended_at : stay.ended_at + 'Z') : null;
            // For ended stays, use stay end time; for active, use now
            const stayEndTime = stayEnded || now;
            const stayDuration = (stayEndTime - stayStarted) / 1000; // in seconds
            const hours = Math.floor(stayDuration / 3600);
            const minutes = Math.floor((stayDuration % 3600) / 60);
            
            // Group sessions by backend and pack into non-overlapping tracks
            const sessionsByBackend = {};
            stay.sessions.forEach(session => {
                const backendKey = session.server_name || session.backend_ip;
                if (!sessionsByBackend[backendKey]) {
                    sessionsByBackend[backendKey] = [];
                }
                sessionsByBackend[backendKey].push(session);
            });
            
            // Pack sessions into tracks (rows) to avoid overlaps
            let totalTracks = 0;
            const backendTracks = {};
            for (const [backendName, sessions] of Object.entries(sessionsByBackend)) {
                // Sort by start time
                const sortedSessions = sessions.sort((a, b) => {
                    const aStarted = new Date(a.started_at.endsWith('Z') ? a.started_at : a.started_at + 'Z');
                    const bStarted = new Date(b.started_at.endsWith('Z') ? b.started_at : b.started_at + 'Z');
                    return aStarted - bStarted;
                });
                
                // Pack into non-overlapping tracks
                const tracks = [];
                sortedSessions.forEach(session => {
                    let placed = false;
                    for (const track of tracks) {
                        const lastSession = track[track.length - 1];
                        const lastEndedStr = lastSession.ended_at ? (lastSession.ended_at.endsWith('Z') ? lastSession.ended_at : lastSession.ended_at + 'Z') : null;
                        const lastEnded = lastEndedStr ? new Date(lastEndedStr) : null;
                        const sessionStartedStr = session.started_at.endsWith('Z') ? session.started_at : session.started_at + 'Z';
                        const sessionStarted = new Date(sessionStartedStr);
                        
                        if (lastEnded && sessionStarted >= lastEnded) {
                            track.push(session);
                            placed = true;
                            break;
                        }
                    }
                    if (!placed) {
                        tracks.push([session]);
                    }
                });
                
                backendTracks[backendName] = tracks;
                totalTracks += tracks.length;
            }
            
            const sessionsHeight = (totalTracks * 40) + 10;
            
            html += `
                <div class="stay-row mb-3 p-2 border border-${stay.is_active ? 'success' : 'secondary'} rounded" style="background: #f8f9fa;">
                    <div class="d-flex align-items-center mb-2">
                        <div style="width: 100%;">
                            <span class="badge bg-${stay.is_active ? 'success' : 'secondary'} me-2">
                                ${stay.is_active ? 'INSIDE' : 'Left'}
                            </span>
                            <strong>${stay.user_name}</strong>
                            <small class="text-muted ms-2">
                                Stay #${stay.id} | 
                                ${formatTime(stayStarted)} - ${stay.is_active ? 'Now' : formatTime(stayEnded)}
                                (${hours}h ${minutes}m)
                                | ${stay.sessions.length} session(s)
                            </small>
                            <a href="/stays/${stay.id}" class="btn btn-sm btn-outline-${stay.is_active ? 'success' : 'secondary'} float-end">
                                <i class="bi bi-eye"></i> Details
                            </a>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center mb-2" style="font-size: 0.75rem;">
                        <span class="text-muted">${formatTime(stayStarted)}</span>
                        <div class="timeline-arrow position-relative mx-2 flex-grow-1" style="height: 2px; background: ${stay.is_active ? '#28a745' : '#6c757d'};">
                            <div class="position-absolute" style="right: -8px; top: -3px; width: 0; height: 0; border-left: 8px solid ${stay.is_active ? '#28a745' : '#6c757d'}; border-top: 4px solid transparent; border-bottom: 4px solid transparent;"></div>
                        </div>
                        <span class="text-muted"><strong>${stay.is_active ? 'Now (' + formatTime(now) + ')' : formatTime(stayEnded)}</strong></span>
                    </div>
                    
                    <div class="sessions-in-stay position-relative" style="height: ${sessionsHeight}px; min-height: 45px;">
                        <div class="stay-bg-bar position-absolute" 
                             style="left: 0%; width: 100%; height: 100%;
                                    background: ${stay.is_active ? 'rgba(40, 167, 69, 0.1)' : 'rgba(108, 117, 125, 0.1)'};
                                    border: 2px solid ${stay.is_active ? '#28a745' : '#6c757d'};
                                    border-radius: 4px;">
                        </div>
            `;
            
            // Iterate over backends and their tracks
            let trackIdx = 0;
            for (const [backendName, tracks] of Object.entries(backendTracks)) {
                tracks.forEach(track => {
                    html += `<div class="backend-row position-relative" style="height: 35px; margin-bottom: 5px;">`;
                    
                    track.forEach((session) => {
                        // Parse session dates as UTC (add 'Z' if missing)
                        const sessionStartedStr = session.started_at.endsWith('Z') ? session.started_at : session.started_at + 'Z';
                        const sessionStarted = new Date(sessionStartedStr);
                        const sessionEnded = session.ended_at ? new Date(session.ended_at.endsWith('Z') ? session.ended_at : session.ended_at + 'Z') : null;
                        
                        // Calculate session position relative to THIS stay's timeline
                        const sessionStartOffset = (sessionStarted - stayStarted) / 1000;
                        // For active sessions, use stay end time (ended or now)
                        const sessionEnd = sessionEnded || stayEndTime;
                        const sessionDuration = (sessionEnd - sessionStarted) / 1000;
                        const sessionLeftPercent = ((sessionStartOffset / stayDuration) * 100).toFixed(2);
                        const sessionWidthPercent = ((sessionDuration / stayDuration) * 100).toFixed(2);
                        
                        // Build popover content with interactive table
                        const durationMinutes = Math.floor(sessionDuration / 60);
                const durationSeconds = Math.floor(sessionDuration % 60);
                
                const popoverContent = `
                    <table class="table table-sm table-borderless mb-0" style="font-size: 0.75rem;">
                        <tr><td><strong>Person:</strong></td><td><a href="/users/${stay.user_id}" class="text-primary">${stay.user_name}</a></td></tr>
                        <tr><td><strong>Protocol:</strong></td><td>${session.protocol.toUpperCase()}</td></tr>
                        ${session.ssh_username ? `<tr><td><strong>SSH User:</strong></td><td>${session.ssh_username}</td></tr>` : ''}
                        ${session.server_name ? `<tr><td><strong>Server:</strong></td><td><a href="/servers/${session.server_id || '#'}" class="text-primary">${session.server_name}</a></td></tr>` : ''}
                        <tr><td><strong>Backend IP:</strong></td><td>${session.backend_ip}</td></tr>
                        <tr><td><strong>Source IP:</strong></td><td>${session.source_ip}</td></tr>
                        ${session.subsystem_name ? `<tr><td><strong>Subsystem:</strong></td><td>${session.subsystem_name}</td></tr>` : ''}
                        ${session.port_forwards_count > 0 ? `<tr><td><strong>Port Forwards:</strong></td><td>${session.port_forwards_count}</td></tr>` : ''}
                        <tr><td><strong>Started:</strong></td><td>${formatTimeWithSeconds(sessionStarted)}</td></tr>
                        ${sessionEnded 
                            ? `<tr><td><strong>Ended:</strong></td><td>${formatTimeWithSeconds(sessionEnded)}</td></tr>
                               <tr><td><strong>Duration:</strong></td><td>${durationMinutes}m ${durationSeconds}s</td></tr>`
                            : `<tr><td><strong>Status:</strong></td><td><span class="badge bg-success">ACTIVE</span></td></tr>`
                        }
                    </table>
                    <div class="text-center mt-2" style="font-size: 0.7rem; color: #999;">Click session bar to view details</div>
                `;
                
                html += `
                    <div class="session-bar position-absolute d-flex align-items-center justify-content-between" 
                         style="left: ${sessionLeftPercent}%; width: max(${sessionWidthPercent}%, 50px); max-width: calc(100% - ${sessionLeftPercent}%); min-width: 50px; height: 30px; 
                                background: ${session.is_active ? 'linear-gradient(90deg, #007bff 0%, #0056b3 100%)' : '#6c757d'}; 
                                border: 2px solid ${session.is_active ? '#0056b3' : '#495057'}; 
                                border-radius: 4px; top: 0px; cursor: pointer; z-index: 10; overflow: hidden;"
                         data-session-id="${session.session_id}"
                         data-bs-toggle="popover" 
                         data-bs-trigger="hover focus"
                         data-bs-html="true" 
                         data-bs-container="body"
                         data-bs-placement="top"
                         data-bs-content="${popoverContent.replace(/"/g, '&quot;')}">
                        <div class="px-2 text-white" style="font-size: 0.65rem;">${formatTimeWithSeconds(sessionStarted)}</div>
                        <div class="px-2 text-white text-center flex-grow-1" style="font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            <i class="bi bi-${session.protocol === 'ssh' ? 'terminal' : 'display'}"></i>
                            ${session.ssh_username ? session.ssh_username + '@' : ''}${session.server_name || session.backend_ip}
                        </div>
                        <div class="px-2 text-white text-end" style="font-size: 0.65rem; min-width: 35px;">
                            ${sessionEnded ? formatTimeWithSeconds(sessionEnded) : '<span class="badge bg-success" style="font-size: 0.55rem; padding: 1px 3px;">●</span>'}
                        </div>
                    </div>
                `;
                    });
                    
                    html += `</div>`; // close backend-row
                    trackIdx++;
                });
            }
            
            html += `</div></div>`;
        });
        
        html += '</div>'; // close stays-rows
    }
    
    html += '</div>'; // close unified-timeline-container
    
    // CRITICAL: Destroy all existing popovers before replacing HTML to prevent memory leaks and conflicts
    var oldPopovers = document.querySelectorAll('[data-bs-toggle="popover"]');
    oldPopovers.forEach(function(el) {
        var popover = bootstrap.Popover.getInstance(el);
        if (popover) {
            popover.dispose();
        }
    });
    
    container.innerHTML = html;
    
    // Initialize Bootstrap popovers (not tooltips)
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.forEach(function (popoverTriggerEl) {
        var popover = new bootstrap.Popover(popoverTriggerEl, {
            sanitize: false  // Allow links in popover
        });
        
        // Close other popovers when this one is shown
        popoverTriggerEl.addEventListener('show.bs.popover', function () {
            popoverTriggerList.forEach(function (otherEl) {
                if (otherEl !== popoverTriggerEl) {
                    var otherPopover = bootstrap.Popover.getInstance(otherEl);
                    if (otherPopover) {
                        otherPopover.hide();
                    }
                }
            });
        });
        
        // Add click handler to redirect to session details
        popoverTriggerEl.addEventListener('click', function(e) {
            var sessionId = popoverTriggerEl.getAttribute('data-session-id');
            if (sessionId) {
                window.location.href = '/sessions/' + sessionId;
            }
        });
    });
}

function formatTime(date) {
    // Convert UTC date to Europe/Warsaw timezone and format as HH:MM
    return new Intl.DateTimeFormat('pl-PL', {
        hour: '2-digit',
        minute: '2-digit',
        timeZone: 'Europe/Warsaw'
    }).format(date);
}

function formatTimeWithSeconds(date) {
    // Convert UTC date to Europe/Warsaw timezone and format as HH:MM:SS
    return new Intl.DateTimeFormat('pl-PL', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        timeZone: 'Europe/Warsaw'
    }).format(date);
}

// Initialize Bootstrap tooltips and popovers, and auto-refresh on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips (for other elements)
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Initialize popovers (for session bars)
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        var popover = new bootstrap.Popover(popoverTriggerEl, {
            sanitize: false  // Allow links in popover
        });
        
        // Close other popovers when this one is shown
        popoverTriggerEl.addEventListener('show.bs.popover', function () {
            popoverTriggerList.forEach(function (otherEl) {
                if (otherEl !== popoverTriggerEl) {
                    var otherPopover = bootstrap.Popover.getInstance(otherEl);
                    if (otherPopover) {
                        otherPopover.hide();
                    }
                }
            });
        });
        
        return popover;
    });
    
    // Start auto-refresh every 5 seconds
    setInterval(refreshDashboard, 5000);
    
    // Initial refresh immediately to populate timeline and chart
    refreshDashboard();
    
    console.log('Dashboard auto-refresh initialized (every 5 seconds with live chart updates)');
});



</script>
{% endblock %}
