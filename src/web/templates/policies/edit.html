{% extends "base.html" %}

{% block title %}Edit Access Policy - Jumphost Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-pencil-square"></i> Edit Access Policy #{{ policy.id }}</h2>
    <a href="{{ url_for('policies.index') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back
    </a>
</div>

<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-body">
                <form method="POST" action="{{ url_for('policies.edit', policy_id=policy.id) }}" id="policyForm">
                    <h5 class="mb-3">1. Grant Details (Read-Only)</h5>
                    
                    <div class="mb-3">
                        <label class="form-label">Granted To</label>
                        <div class="form-control-plaintext bg-light p-2 rounded">
                            {% if policy.user %}
                                <i class="bi bi-person"></i> User: <strong>{{ policy.user.full_name or policy.user.username }}</strong> ({{ policy.user.email or 'no email' }})
                            {% elif policy.user_group %}
                                <i class="bi bi-people"></i> User Group: <strong>{{ policy.user_group.name }}</strong> ({{ policy.user_group.members|length }} members)
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Target</label>
                        <div class="form-control-plaintext bg-light p-2 rounded">
                            {% if policy.scope_type == 'group' %}
                                <i class="bi bi-hdd-rack"></i> Server Group: <strong>{{ policy.target_group.name }}</strong> ({{ policy.target_group.members|length }} servers)
                            {% elif policy.scope_type == 'server' %}
                                <i class="bi bi-server"></i> Server: <strong>{{ policy.target_server.name }}</strong> ({{ policy.target_server.ip_address }})
                            {% elif policy.scope_type == 'service' %}
                                <i class="bi bi-hdd-network"></i> Service: <strong>{{ policy.target_server.name }}</strong> ({{ policy.protocol|upper }})
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        User/group and server/group cannot be changed after policy creation. 
                        Only times, schedules, SSH logins, and permissions can be edited.
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">2. SSH Configuration (Optional)</h5>
                    
                    <div class="mb-3">
                        <label for="ssh_logins" class="form-label">Allowed SSH Logins</label>
                        <input type="text" class="form-control" id="ssh_logins" name="ssh_logins" 
                               value="{{ policy.ssh_logins|map(attribute='allowed_login')|join(',') }}"
                               placeholder="root,admin,ubuntu">
                        <small class="form-text text-muted">
                            Comma-separated list of allowed SSH usernames. Leave empty for no restrictions.
                        </small>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">3. Additional Permissions</h5>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="port_forwarding_allowed" 
                                   name="port_forwarding_allowed" {{ 'checked' if policy.port_forwarding_allowed }}>
                            <label class="form-check-label" for="port_forwarding_allowed">
                                <i class="bi bi-arrow-left-right"></i> Allow SSH Port Forwarding
                            </label>
                            <small class="form-text text-muted d-block">
                                Enable local/remote port forwarding and dynamic SOCKS proxy (ssh -L, -R, -D)
                            </small>
                        </div>
                    </div>
                    
                    {% if policy.source_ip %}
                    <div class="mb-3">
                        <label class="form-label">Source IP</label>
                        <div class="form-control-plaintext bg-light p-2 rounded">
                            <i class="bi bi-geo-alt"></i> {{ policy.source_ip.ip }} 
                            {% if policy.source_ip.label %}({{ policy.source_ip.label }}){% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <input type="hidden" name="source_ip_id" value="{{ policy.source_ip_id or '' }}">
                    <input type="hidden" name="protocol" value="{{ policy.protocol or '' }}">
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">4. Time Configuration</h5>
                    
                    <div class="mb-3">
                        <label for="start_time" class="form-label">Start Time (UTC)</label>
                        <input type="datetime-local" class="form-control" id="start_time" name="start_time" 
                               value="{{ policy.start_time.strftime('%Y-%m-%dT%H:%M') if policy.start_time else '' }}">
                        <small class="form-text text-muted">
                            Current: {{ policy.start_time.strftime('%Y-%m-%d %H:%M UTC') if policy.start_time else 'Not set' }}
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="end_time" class="form-label">End Time (UTC)</label>
                        <input type="datetime-local" class="form-control" id="end_time" name="end_time" 
                               value="{{ policy.end_time.strftime('%Y-%m-%dT%H:%M') if policy.end_time else '' }}">
                        <small class="form-text text-muted">
                            Current: {{ policy.end_time.strftime('%Y-%m-%d %H:%M UTC') if policy.end_time else 'Permanent' }}
                            <br>Leave empty for permanent access.
                        </small>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">5. Session Settings</h5>
                    
                    <div class="mb-3">
                        <label for="inactivity_timeout_minutes" class="form-label">Inactivity Timeout (minutes)</label>
                        <input type="number" class="form-control" id="inactivity_timeout_minutes" 
                               name="inactivity_timeout_minutes" 
                               value="{{ policy.inactivity_timeout_minutes if policy.inactivity_timeout_minutes is not none else 60 }}" 
                               min="0" max="1440">
                        <small class="form-text text-muted">
                            Current: {{ policy.inactivity_timeout_minutes if policy.inactivity_timeout_minutes else 'Disabled' }} minutes
                            <br>Sessions disconnect after this many minutes of no activity. Set to <code>0</code> to disable.
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="mfa_required" 
                                   name="mfa_required" {{ 'checked' if policy.mfa_required }}>
                            <label class="form-check-label" for="mfa_required">
                                <i class="bi bi-shield-lock"></i> Require MFA (Multi-Factor Authentication)
                            </label>
                            <small class="form-text text-muted d-block">
                                Current: {{ 'Enabled' if policy.mfa_required else 'Disabled' }}
                                <br>User must complete Azure AD SAML authentication before accessing the server.
                                MFA challenge displayed in SSH banner with link and QR code.
                            </small>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">6. Recurring Schedule (Optional)</h5>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="use_schedules" 
                                   name="use_schedules" {{ 'checked' if policy.use_schedules }} onchange="toggleScheduleFields()">
                            <label class="form-check-label" for="use_schedules">
                                <i class="bi bi-calendar-week"></i> Enable Recurring Time Windows
                            </label>
                            <small class="form-text text-muted d-block">
                                Restrict access to specific days of week, time ranges, months, or days of month.
                            </small>
                        </div>
                    </div>
                    
                    <div id="scheduleFields" style="display: {{ 'block' if policy.use_schedules else 'none' }};">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Multiple schedules work with OR logic:</strong> If any schedule matches current time, access is granted.
                            Use multiple schedules for complex patterns like "Mon-Fri 8-16 OR Sat 2-6".
                        </div>
                        
                        <div id="scheduleList"></div>
                        
                        <div class="card bg-light mt-3">
                            <div class="card-body">
                                <h6>Add/Edit Schedule Rule</h6>
                                
                                <input type="hidden" id="editing_schedule_index" value="">
                                
                                <div class="mb-3">
                                    <label class="form-label">Schedule Name</label>
                                    <input type="text" class="form-control" id="schedule_name" 
                                           placeholder="e.g., Business Hours, Weekend Maintenance">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Days of Week (leave all unchecked for all days)</label>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input weekday-check" value="0" id="wd_mon">
                                            <label class="form-check-label" for="wd_mon">Mon</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input weekday-check" value="1" id="wd_tue">
                                            <label class="form-check-label" for="wd_tue">Tue</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input weekday-check" value="2" id="wd_wed">
                                            <label class="form-check-label" for="wd_wed">Wed</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input weekday-check" value="3" id="wd_thu">
                                            <label class="form-check-label" for="wd_thu">Thu</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input weekday-check" value="4" id="wd_fri">
                                            <label class="form-check-label" for="wd_fri">Fri</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input weekday-check" value="5" id="wd_sat">
                                            <label class="form-check-label" for="wd_sat">Sat</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input weekday-check" value="6" id="wd_sun">
                                            <label class="form-check-label" for="wd_sun">Sun</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Time Start (24h)</label>
                                        <input type="time" class="form-control" id="time_start" value="00:00">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Time End (24h)</label>
                                        <input type="time" class="form-control" id="time_end" value="23:59">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Months (leave all unchecked for all months)</label>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="1" id="m_jan">
                                            <label class="form-check-label" for="m_jan">Jan</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="2" id="m_feb">
                                            <label class="form-check-label" for="m_feb">Feb</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="3" id="m_mar">
                                            <label class="form-check-label" for="m_mar">Mar</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="4" id="m_apr">
                                            <label class="form-check-label" for="m_apr">Apr</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="5" id="m_may">
                                            <label class="form-check-label" for="m_may">May</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="6" id="m_jun">
                                            <label class="form-check-label" for="m_jun">Jun</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="7" id="m_jul">
                                            <label class="form-check-label" for="m_jul">Jul</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="8" id="m_aug">
                                            <label class="form-check-label" for="m_aug">Aug</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="9" id="m_sep">
                                            <label class="form-check-label" for="m_sep">Sep</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="10" id="m_oct">
                                            <label class="form-check-label" for="m_oct">Oct</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="11" id="m_nov">
                                            <label class="form-check-label" for="m_nov">Nov</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input month-check" value="12" id="m_dec">
                                            <label class="form-check-label" for="m_dec">Dec</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Days of Month (optional)</label>
                                    <input type="text" class="form-control" id="days_of_month" 
                                           placeholder="e.g., 1,15 or 1-7 or 1,10,20">
                                    <small class="form-text text-muted">
                                        Comma-separated days (1-31). Leave empty for all days.
                                    </small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Timezone</label>
                                    <select class="form-select" id="timezone">
                                        <option value="Europe/Warsaw" selected>Europe/Warsaw (CET/CEST)</option>
                                        <option value="UTC">UTC</option>
                                        <option value="Europe/London">Europe/London</option>
                                        <option value="America/New_York">America/New_York (EST/EDT)</option>
                                        <option value="America/Los_Angeles">America/Los_Angeles (PST/PDT)</option>
                                        <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
                                    </select>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-success" onclick="saveSchedule()">
                                        <i class="bi bi-check-circle"></i> <span id="scheduleButtonText">Add Schedule</span>
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="cancelScheduleEdit()" id="cancelEditBtn" style="display: none;">
                                        <i class="bi bi-x-circle"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="d-flex justify-content-end gap-2">
                        <a href="{{ url_for('policies.index') }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load existing schedules from server
let schedules = {{ schedules_json|safe }};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    renderSchedules();
});

function toggleScheduleFields() {
    const useSchedules = document.getElementById('use_schedules').checked;
    document.getElementById('scheduleFields').style.display = useSchedules ? 'block' : 'none';
}

function parseCommaSeparatedInts(str) {
    if (!str || !str.trim()) return null;
    const parts = str.split(',').map(s => s.trim()).filter(s => s);
    const result = [];
    for (const part of parts) {
        if (part.includes('-')) {
            const [start, end] = part.split('-').map(n => parseInt(n.trim()));
            for (let i = start; i <= end; i++) {
                if (!result.includes(i)) result.push(i);
            }
        } else {
            const num = parseInt(part);
            if (!result.includes(num)) result.push(num);
        }
    }
    return result.length > 0 ? result : null;
}

function saveSchedule() {
    const editingIndex = document.getElementById('editing_schedule_index').value;
    const name = document.getElementById('schedule_name').value.trim() || 'Unnamed Schedule';
    
    // Weekdays
    const weekdayChecks = document.querySelectorAll('.weekday-check:checked');
    const weekdays = weekdayChecks.length > 0 ? Array.from(weekdayChecks).map(c => parseInt(c.value)) : null;
    
    // Time
    const timeStart = document.getElementById('time_start').value || '00:00';
    const timeEnd = document.getElementById('time_end').value || '23:59';
    
    // Months
    const monthChecks = document.querySelectorAll('.month-check:checked');
    const months = monthChecks.length > 0 ? Array.from(monthChecks).map(c => parseInt(c.value)) : null;
    
    // Days of month
    const daysOfMonth = parseCommaSeparatedInts(document.getElementById('days_of_month').value);
    
    const timezone = document.getElementById('timezone').value;
    
    const schedule = {
        name: name,
        weekdays: weekdays,
        time_start: timeStart,
        time_end: timeEnd,
        months: months,
        days_of_month: daysOfMonth,
        timezone: timezone,
        is_active: true
    };
    
    if (editingIndex !== '') {
        // Update existing schedule
        const idx = parseInt(editingIndex);
        schedule.id = schedules[idx].id;  // Keep existing ID
        schedules[idx] = schedule;
    } else {
        // Add new schedule (no ID means new)
        schedules.push(schedule);
    }
    
    renderSchedules();
    clearScheduleForm();
}

function editSchedule(index) {
    const schedule = schedules[index];
    
    // Populate form
    document.getElementById('schedule_name').value = schedule.name || '';
    document.getElementById('time_start').value = schedule.time_start || '00:00';
    document.getElementById('time_end').value = schedule.time_end || '23:59';
    document.getElementById('timezone').value = schedule.timezone || 'Europe/Warsaw';
    
    // Weekdays
    document.querySelectorAll('.weekday-check').forEach(c => {
        c.checked = schedule.weekdays && schedule.weekdays.includes(parseInt(c.value));
    });
    
    // Months
    document.querySelectorAll('.month-check').forEach(c => {
        c.checked = schedule.months && schedule.months.includes(parseInt(c.value));
    });
    
    // Days of month
    if (schedule.days_of_month && schedule.days_of_month.length > 0) {
        document.getElementById('days_of_month').value = schedule.days_of_month.join(',');
    } else {
        document.getElementById('days_of_month').value = '';
    }
    
    // Set editing mode
    document.getElementById('editing_schedule_index').value = index;
    document.getElementById('scheduleButtonText').textContent = 'Update Schedule';
    document.getElementById('cancelEditBtn').style.display = 'inline-block';
    
    // Scroll to form
    document.querySelector('.card.bg-light').scrollIntoView({ behavior: 'smooth' });
}

function cancelScheduleEdit() {
    clearScheduleForm();
}

function removeSchedule(index) {
    if (confirm('Remove this schedule?')) {
        schedules.splice(index, 1);
        renderSchedules();
    }
}

function clearScheduleForm() {
    document.getElementById('schedule_name').value = '';
    document.querySelectorAll('.weekday-check').forEach(c => c.checked = false);
    document.getElementById('time_start').value = '00:00';
    document.getElementById('time_end').value = '23:59';
    document.querySelectorAll('.month-check').forEach(c => c.checked = false);
    document.getElementById('days_of_month').value = '';
    document.getElementById('timezone').value = 'Europe/Warsaw';
    document.getElementById('editing_schedule_index').value = '';
    document.getElementById('scheduleButtonText').textContent = 'Add Schedule';
    document.getElementById('cancelEditBtn').style.display = 'none';
}

function formatScheduleDescription(schedule) {
    const weekdayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    let parts = [];
    
    // Weekdays
    if (schedule.weekdays && schedule.weekdays.length > 0) {
        if (schedule.weekdays.length === 5 && 
            [0,1,2,3,4].every(d => schedule.weekdays.includes(d))) {
            parts.push('Mon-Fri');
        } else if (schedule.weekdays.length === 2 && 
                   schedule.weekdays.includes(5) && schedule.weekdays.includes(6)) {
            parts.push('Weekends only');
        } else {
            const days = schedule.weekdays.map(d => weekdayNames[d]).join('/');
            parts.push(days);
        }
    }
    
    // Time
    if (schedule.time_start !== '00:00' || schedule.time_end !== '23:59') {
        parts.push(`${schedule.time_start}-${schedule.time_end}`);
    }
    
    // Months
    if (schedule.months && schedule.months.length > 0) {
        const months = schedule.months.map(m => monthNames[m-1]).join('/');
        parts.push(months + ' only');
    }
    
    // Days of month
    if (schedule.days_of_month && schedule.days_of_month.length > 0) {
        if (schedule.days_of_month.length === 1 && schedule.days_of_month[0] === 1) {
            parts.push('First day of month');
        } else {
            parts.push('Days: ' + schedule.days_of_month.join(','));
        }
    }
    
    // Timezone
    if (schedule.timezone !== 'Europe/Warsaw') {
        parts.push(`(${schedule.timezone})`);
    }
    
    return parts.length > 0 ? parts.join(' ') : 'All times';
}

function renderSchedules() {
    const container = document.getElementById('scheduleList');
    if (schedules.length === 0) {
        container.innerHTML = '<p class="text-muted">No schedules added yet.</p>';
        return;
    }
    
    let html = '';
    schedules.forEach((schedule, index) => {
        const description = formatScheduleDescription(schedule);
        const statusBadge = schedule.is_active ? 
            '<span class="badge bg-success">Active</span>' : 
            '<span class="badge bg-secondary">Inactive</span>';
        
        html += `
            <div class="card mb-2">
                <div class="card-body py-2 d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${schedule.name}</strong> ${statusBadge}
                        <br>
                        <small class="text-muted">${description}</small>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="editSchedule(${index})">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSchedule(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

// Submit handler to include schedules as JSON
document.getElementById('policyForm').addEventListener('submit', function(e) {
    if (document.getElementById('use_schedules').checked) {
        // Add schedules as JSON to form data
        const schedulesInput = document.createElement('input');
        schedulesInput.type = 'hidden';
        schedulesInput.name = 'schedules_json';
        schedulesInput.value = JSON.stringify(schedules);
        this.appendChild(schedulesInput);
    }
});
</script>
{% endblock %}
